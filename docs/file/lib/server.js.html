<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/server.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/hoist/hoist-git-listener.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/lib/git_action_listener.js~GitActionListener.html">GitActionListener</a></span></li>
</ul>
</div>





<div data-ice="variableWrap">
  <h2><a href="variable/">Variable</a></h2>
  <ul>
    
  <li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-gitActionListener">gitActionListener</a></span></li>
</ul>
</div>




</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/server.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;
var http = require(&apos;http&apos;);
var pushover = require(&apos;pushover&apos;);
var config = require(&apos;config&apos;);
var repos = pushover(config.get(&apos;Hoist.filePaths.repositories&apos;), {
  autoCreate: true
});
var GitActionListener = require(&apos;./git_action_listener&apos;);
var BBPromise = require(&apos;bluebird&apos;);
var mongoose = BBPromise.promisifyAll(require(&apos;@hoist/model&apos;)._mongoose);
var logger = require(&apos;@hoist/logger&apos;);

repos.on(&apos;error&apos;, function (err) {
  console.warn(err);
});

module.exports = {
  createServer: function () {
    var listener = new GitActionListener();
    listener.bindToRepository(repos);
    return BBPromise.promisifyAll(http.createServer(function (req, res) {
      logger.info(&quot;got a git request&quot;);
      if (!req.headers || !req.headers.authorization) {
        logger.warn(&quot;no auth header present&quot;);
        res.setHeader(&quot;WWW-Authenticate&quot;, &apos;Basic&apos;);
        res.writeHead(401);
        res.end(&quot;invalid username or password&quot;);
      } else {
        logger.info(&apos;sending to handler&apos;);
        repos.handle(req, res);
      }
    }));
  },
  start: function (done) {
    return BBPromise.try(function () {
        var connected = false;
        if (mongoose.connection &amp;&amp; mongoose.connection.readyState &gt; 0) {
          connected = true;
        }
        return connected;
      })
      .bind(this)
      .then(function (connected) {
        if (!connected) {
          return mongoose.connectAsync(config.get(&apos;Hoist.mongo.core.connectionString&apos;));
        } else {
          return null;
        }
      }).then(function () {
        /* istanbul ignore if */
        if (this._server) {
          return BBPromise.resolve(null);
        }
        this._server = this.createServer();
        return this._server.listenAsync(config.get(&apos;Hoist.server.port&apos;), config.get(&apos;Hoist.server.host&apos;));
      }).then(function () {
        logger.info(&apos;listening for git actions on port, &apos; + config.get(&apos;Hoist.server.port&apos;));
      }).nodeify(done);
  },
  stop: function (done) {
    return BBPromise.try(function () {
      var connected = false;
      /* istanbul ignore else */
      if (mongoose.connection &amp;&amp; mongoose.connection.readyState &gt; 0 &amp;&amp; mongoose.connection.readyState &lt; 3) {
        connected = true;
      }
      return connected;
    }).bind(this).then(function (connected) {
      /* istanbul ignore else */
      if (connected) {
        return mongoose.disconnectAsync();
      }
    }).then(function () {
      /* istanbul ignore if */
      if (!this._server) {
        return BBPromise.resolve(null);
      }
      return this._server.closeAsync();
    }).then(function () {
      delete this._server;
    }).nodeify(done);
  }
};
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
